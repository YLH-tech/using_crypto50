
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Crypto Market</title>
    <link rel="stylesheet" href="chart.css">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        // Lazy load TradingView script
        function loadTradingView() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = "https://s3.tradingview.com/tv.js";
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load TradingView script.'));
                document.body.appendChild(script);
            });
        }

        // Function to load TradingView widget
        function loadWidget() {
            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:BTCUSDT",
                "interval": "1",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "hide_legend": true,
                "hide_side_toolbar": false,
                "allow_symbol_change": false,
                "save_image": false,
                "details": true,
                "calendar": false,
                "container_id": "tradingview-chart" // Ensure this ID matches the HTML element
            });
        }

        // Load TradingView chart after the page has loaded
        window.addEventListener('load', () => {
            loadTradingView()
                .then(loadWidget)
                .catch(error => {
                    console.error(error);
                    document.getElementById('tradingview-chart').innerText = 'Failed to load chart. Please try again later.';
                });
        });
    </script>
</head>
<body>
    <header>
        <h1>BTCUSDT</h1>
        <div>
            <span id="price-change-info">24h Change: 0.00%</span>
        </div>
    </header>

    <div class="container">
        <aside class="market-list">
            <ul id="market-list">
                <li data-symbol="btcusdt">
                    <strong>BTCUSDT</strong> <span class="price">$0.00</span> <span class="change">(0.00%)</span>
                </li>
                <li data-symbol="ethusdt">
                    <strong>ETHUSDT</strong> <span class="price">$0.00</span> <span class="change">(0.00%)</span>
                </li>
                <!-- Add other market pairs here -->
            </ul>
        </aside>

        <main class="chart-area">
            <div class="tradingview-widget-container" style="height:100%; width:100%">
                <div id="tradingview-chart" style="height: 500px;"></div>
            </div>
            <div class="trade-columns">
                <div class="buy-column">
                    <p>Available USDT: <span id="available-usdt">Loading...</span></p>
                    <div id="maxBuyBTC">Max Buy BTC: 0.000000</div>
                    <form id="buy-form">
                        <label for="buy-price">Price (USDT):</label>
                        <input type="number" id="buy-price" placeholder="Price" value="50000" min="0" step="0.01">
                        
                        <label for="buy-amount">Amount (BTC):</label>
                        <input type="number" id="buy-amount" placeholder="Amount" value="0.00" min="0" step="0.01">
                        
                        <button type="submit" id="buy-button" disabled>Buy BTC</button>
                    </form>
                </div>

                <div class="sell-column">
                    <p>Available BTC: <span id="available-btc">1.500 BTC</span></p>
                    <p>Max Sell USDT: <span id="max-sell-usdt">75,000 USDT</span></p>
                    <form id="sell-form">
                        <label for="sell-price">Price (USDT):</label>
                        <input type="number" id="sell-price" placeholder="Price" value="50000" min="0" step="0.01">
                        
                        <label for="sell-amount">Amount (BTC):</label>
                        <input type="number" id="sell-amount" placeholder="Amount" value="0.00" min="0" step="0.01">
                        
                        <button type="submit" id="sell-button" disabled>Sell BTC</button>
                    </form>
                </div>
            </div>
            
            <script>
                async function displayAvailableUSDT() {
                    try {
                        const response = await fetch('getBalance.php'); // Your PHP file that fetches the balance
                        const data = await response.json();
                        
                        // Check if there was an error in the response
                        if (data.error) {
                            console.error('Error fetching USDT balance:', data.error);
                            document.getElementById('available-usdt').textContent = 'Error fetching balance';
                            return;
                        }

                        const availableUSDT = parseFloat(data.usdt).toFixed(2); // Assuming 'usdt' is the key in your response
                        document.getElementById('available-usdt').textContent = `${availableUSDT} USDT`;
                    } catch (error) {
                        console.error('Error fetching USDT balance:', error);
                        document.getElementById('available-usdt').textContent = 'Error fetching balance';
                    }
                }

                // Call the function to display the USDT balance when the page loads
                document.addEventListener('DOMContentLoaded', displayAvailableUSDT);

            async function updateMaxBuyBTC() {
                const userBalanceUSDT = await getUserBalance();
                const currentBTCPrice = await getCurrentBTCPrice(); // Function to get the real-time price

                if (currentBTCPrice > 0) {
                    const maxBuyBTC = (userBalanceUSDT / currentBTCPrice).toFixed(6); // Adjust the decimal places as needed
                    document.getElementById('maxBuyBTC').textContent = `Max Buy BTC: ${maxBuyBTC}`;
                } else {
                    document.getElementById('maxBuyBTC').textContent = 'Price not available';
                }
            }

            
            </script>

        </main>

        <aside class="order-book">
            <table id="orderTable">
                <thead>
                    <tr>
                        <th>Price (USDT)</th>
                        <th>Amount (BTC)</th>
                        <th>Total (USDT)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Order rows will be dynamically inserted here -->
                </tbody>
            </table>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function setCurrentPrice() {
                const apiUrl = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd';
                const cacheBustingUrl = apiUrl + '&timestamp=' + new Date().getTime();

                fetch(cacheBustingUrl)
                    .then(response => response.json())
                    .then(data => {
                        let currentPrice = data.bitcoin.usd;
                        currentPrice = currentPrice.toFixed(2);
                        document.getElementById('buy-price').value = currentPrice;
                        document.getElementById('sell-price').value = currentPrice;
                    })
                    .catch(error => {
                        console.error('Error fetching the current price:', error);
                    });
            }

            function validateInputs() {
                const buyAmount = parseFloat(document.getElementById('buy-amount').value);
                const sellAmount = parseFloat(document.getElementById('sell-amount').value);
                document.getElementById('buy-button').disabled = !(buyAmount > 0);
                document.getElementById('sell-button').disabled = !(sellAmount > 0);
            }

            document.getElementById('buy-amount').addEventListener('input', validateInputs);
            document.getElementById('sell-amount').addEventListener('input', validateInputs);
            setCurrentPrice();
        });
    </script>

    <script src="chart.js"></script>
</body>
</html>
